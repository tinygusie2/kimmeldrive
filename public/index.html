<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestandsbeheer (M3, Responsive, D&D, Editor)</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <style>
        /* --- Material You Inspired Variables --- */
        :root {
            --md-sys-color-primary: #0b57d0; /* Blue accent */
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3ff;
            --md-sys-color-on-primary-container: #001849;

            --md-sys-color-secondary: #565e71;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #dae2f9;
            --md-sys-color-on-secondary-container: #131c2b;

            --md-sys-color-tertiary: #715573;
            --md-sys-color-on-tertiary: #ffffff;
            --md-sys-color-tertiary-container: #fbd7fc;
            --md-sys-color-on-tertiary-container: #29132d;

            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;
            --md-sys-color-on-error-container: #410002;

            --md-sys-color-background: #fefbff; /* Slightly off-white */
            --md-sys-color-on-background: #1b1b1f;
            --md-sys-color-surface: #fefbff; /* Cards, dialogs */
            --md-sys-color-on-surface: #1b1b1f;
            --md-sys-color-surface-variant: #e1e2ec; /* Subtle backgrounds, dividers */
            --md-sys-color-on-surface-variant: #44474f; /* Medium emphasis text, icons */
            --md-sys-color-outline: #74777f; /* Borders */

            --md-sys-border-radius-s: 4px;
            --md-sys-border-radius-m: 8px;
            --md-sys-border-radius-l: 16px;
            --md-sys-border-radius-xl: 28px;
            --md-sys-border-radius-full: 999px;

            --md-sys-elevation-1: 0 1px 2px 0 rgba(0, 0, 0, 0.1), 0 1px 3px 1px rgba(0, 0, 0, 0.08);
            --md-sys-elevation-2: 0 1px 2px 0 rgba(0, 0, 0, 0.1), 0 2px 6px 2px rgba(0, 0, 0, 0.08);
            --md-sys-elevation-3: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 4px 8px 3px rgba(0, 0, 0, 0.08);
        }

        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Google Sans';
            font-size: 16px;
            line-height: 1.5;
            margin: 0;
            padding: 16px;
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
        }

        .container {
            background-color: var(--md-sys-color-surface);
            padding: 20px;
            border-radius: var(--md-sys-border-radius-l);
            box-shadow: var(--md-sys-elevation-1);
            max-width: 1100px;
            margin: 0 auto;
        }

        /* Typography */
        h1 { font-size: 1.6rem; font-weight: 500; color: var(--md-sys-color-primary); margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--md-sys-color-surface-variant); }
        h2 { font-size: 1.25rem; font-weight: 500; color: var(--md-sys-color-primary); margin: 24px 0 16px; }
        h3 { font-size: 1rem; font-weight: 500; color: var(--md-sys-color-on-surface); margin: 0 0 12px; }

        /* List Styles */
        ul#item-list { list-style: none; min-height: 100px; /* Provide drop zone space when empty */ }
        li.item-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            padding: 12px 4px;
            border-bottom: 1px solid var(--md-sys-color-surface-variant);
            transition: background-color 0.15s ease-out, opacity 0.2s ease-out; /* Added opacity transition */
            cursor: grab; /* Indicate draggable */
        }
        li.item-row:last-child { border-bottom: none; }
        li.item-row:hover { background-color: rgba(0, 0, 0, 0.04); }

        /* Drag and Drop Styling */
        li.dragging { opacity: 0.4; background-color: var(--md-sys-color-primary-container) !important; cursor: grabbing; }
        li.drop-target-hover { background-color: var(--md-sys-color-secondary-container) !important; outline: 2px dashed var(--md-sys-color-primary); outline-offset: -2px;}

        .item-info { display: flex; align-items: center; flex-grow: 1; flex-basis: 200px; margin-right: 8px; }
        .item-info .icon { margin-right: 12px; font-size: 24px; color: var(--md-sys-color-on-surface-variant); font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; flex-shrink: 0; }
        .item-info a, .item-info span { text-decoration: none; color: var(--md-sys-color-on-surface); font-size: 0.95rem; word-break: break-all; cursor: default; }
        .item-info a.folder-link { color: var(--md-sys-color-primary); cursor: pointer; }
        .item-info a.folder-link:hover { text-decoration: underline; }

        .item-actions { display: flex; gap: 4px; align-items: center; flex-shrink: 0; width: 100%; padding-top: 8px; justify-content: flex-end; }

        /* Icon Buttons */
        .icon-button { display: inline-flex; align-items: center; justify-content: center; background: none; border: none; border-radius: 50%; width: 36px; height: 36px; padding: 0; cursor: pointer; transition: background-color 0.15s ease-out; font-family: 'Material Symbols Outlined', sans-serif; font-size: 20px; font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 20; color: var(--md-sys-color-on-surface-variant); }
        .icon-button:hover { background-color: rgba(0, 0, 0, 0.06); }
        .delete-btn { color: var(--md-sys-color-error); }
        .download-link, .preview-btn, .edit-btn, .share-btn { color: var(--md-sys-color-primary); }

        /* Navigation */
        #navigation { margin-bottom: 20px; }
        #current-path { font-size: 0.875rem; color: var(--md-sys-color-on-surface-variant); margin-bottom: 8px; word-break: break-all; }
        #parent-link { display: inline-flex; align-items: center; gap: 8px; font-size: 0.875rem; color: var(--md-sys-color-primary); text-decoration: none; margin-bottom: 16px; padding: 4px 8px; border-radius: var(--md-sys-border-radius-m); transition: background-color 0.15s ease-out; }
        #parent-link:hover { background-color: rgba(var(--md-sys-color-primary), 0.08); text-decoration: none; }
        #parent-link .icon { font-size: 20px; margin-right: 0; }

        /* Action Sections */
        .action-section { margin-top: 24px; padding: 20px; background-color: var(--md-sys-color-surface-variant); border-radius: var(--md-sys-border-radius-l); border: none; }
        form { display: flex; flex-wrap: wrap; gap: 12px; align-items: center; }
        input[type="text"] { padding: 12px 14px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-border-radius-s); font-size: 1rem; flex-grow: 1; min-width: 180px; background-color: var(--md-sys-color-surface); transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        input[type="text"]:focus { border-color: var(--md-sys-color-primary); box-shadow: 0 0 0 1px var(--md-sys-color-primary); outline: none; }
        input[type="file"] { display: none; }
        .file-input-label { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-border-radius-full); background-color: var(--md-sys-color-surface); color: var(--md-sys-color-primary); font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s ease; }
        .file-input-label:hover { background-color: rgba(var(--md-sys-color-primary), 0.08); }
        .file-input-label .icon { font-size: 20px; margin: 0; color: var(--md-sys-color-primary); }
        #file-name-display { font-size: 0.8rem; margin-top: 8px; color: var(--md-sys-color-on-surface-variant); min-height: 1.2em; }

        /* Buttons */
        button.m3-button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; border: none; border-radius: var(--md-sys-border-radius-full); font-size: 0.875rem; font-weight: 500; letter-spacing: 0.1px; cursor: pointer; transition: background-color 0.2s ease, box-shadow 0.2s ease; box-shadow: var(--md-sys-elevation-1); background-color: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); }
        button.m3-button:hover { background-color: color-mix(in srgb, var(--md-sys-color-primary), black 8%); box-shadow: var(--md-sys-elevation-2); }
        button.m3-button .icon { font-size: 18px; margin: 0; }
        button:disabled { background-color: var(--md-sys-color-outline); color: var(--md-sys-color-surface); cursor: not-allowed; box-shadow: none; }


        /* Share Display */
        #share-link-display { margin-top: 24px; padding: 20px; background-color: var(--md-sys-color-primary-container); border-radius: var(--md-sys-border-radius-l); display: none; text-align: center; }
        #share-link-display p { margin: 0 0 12px; font-weight: 500; font-size: 1rem; color: var(--md-sys-color-on-primary-container); }
        #share-link-display input { width: 95%; padding: 12px 14px; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-border-radius-s); font-size: 1rem; text-align: center; background-color: var(--md-sys-color-surface); margin-bottom: 12px; }
        #share-qr-code { max-width: 150px; height: auto; margin: 12px auto 0; display: block; border-radius: var(--md-sys-border-radius-m); }
        #share-expiry-info { font-size: 0.75rem; color: var(--md-sys-color-on-primary-container); margin-top: 12px; }

        /* Status Messages */
        #status { margin-top: 20px; padding: 12px 16px; border-radius: var(--md-sys-border-radius-l); font-size: 0.875rem; text-align: center; display: none; border: none; }
        #status.success { background-color: #c8e6c9; color: #2e7d32; display: block; }
        #status.error { background-color: #ffcdd2; color: #c62828; display: block; }
        #status.info { background-color: #bbdefb; color: #0d47a1; display: block; }

        /* Modal Styles */
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.4); align-items: center; justify-content: center; z-index: 1000; padding: 16px; }
        .modal-content { background-color: var(--md-sys-color-surface); border-radius: var(--md-sys-border-radius-xl); padding: 20px; max-width: 95vw; max-height: 90vh; width: 900px; overflow: hidden; display: flex; flex-direction: column; box-shadow: var(--md-sys-elevation-3); position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-shrink: 0; padding-right: 40px; /* Space for close button */}
        .modal-title { font-size: 1.25rem; font-weight: 500; color: var(--md-sys-color-on-surface); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .modal-body { overflow-y: auto; flex-grow: 1; margin-bottom: 16px; /* Space before footer */ }
        .modal-footer { display: flex; justify-content: flex-end; gap: 8px; flex-shrink: 0; padding-top: 16px; border-top: 1px solid var(--md-sys-color-surface-variant);}

        /* Preview specific */
        .modal-body img { max-width: 100%; height: auto; display: block; margin: 0 auto; border-radius: var(--md-sys-border-radius-m); }
        .modal-body iframe { width: 100%; height: 65vh; border: none; border-radius: var(--md-sys-border-radius-m); }
        .modal-body pre { white-space: pre-wrap; word-break: break-all; background-color: var(--md-sys-color-surface-variant); padding: 16px; border-radius: var(--md-sys-border-radius-m); font-size: 0.875rem; max-height: 65vh; overflow: auto; color: var(--md-sys-color-on-surface-variant); }
        .modal-body audio, .modal-body video { max-width: 100%; display: block; margin: auto; }
        .modal-body p.preview-unavailable { font-size: 1rem; color: var(--md-sys-color-on-surface-variant); text-align: center; padding: 32px 0; }

        /* Editor specific */
        #editor-textarea { width: 100%; height: 60vh; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-border-radius-s); padding: 12px; font-family: 'Courier New', Courier, monospace; font-size: 0.9rem; resize: vertical; background-color: var(--md-sys-color-surface); color: var(--md-sys-color-on-surface); }

        .close-btn { /* Use icon button base */ position: absolute; top: 12px; right: 12px; }

        /* Material Symbols */
        .icon, .icon-button, .close-btn, .file-input-label .icon, button.m3-button .icon, #parent-link .icon { font-family: 'Material Symbols Outlined', sans-serif; font-weight: normal; font-style: normal; line-height: 1; letter-spacing: normal; text-transform: none; display: inline-block; white-space: nowrap; word-wrap: normal; direction: ltr; -webkit-font-smoothing: antialiased; }

        /* Responsive Adjustments */
        @media (min-width: 768px) {
            body { padding: 24px; }
            .container { padding: 24px 32px; }
            li.item-row { flex-wrap: nowrap; }
            .item-actions { width: auto; padding-top: 0; justify-content: flex-end; }
            .item-info { margin-right: 16px; }
            .modal-content { width: 800px; max-width: 80vw;}
        }
        @media (max-width: 600px) {
             form { flex-direction: column; align-items: stretch; }
             input[type="text"], .file-input-label, button.m3-button { width: 100%; min-width: unset; justify-content: center; }
        }

        google-cast-launcher {
            width: 48px;
            height: 48px;
            display: inline-block;
            cursor: pointer;
            margin-top: 12px;
        }


    </style>

    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <script>
    window['__onGCastApiAvailable'] = function(isAvailable) {
        if (isAvailable) {
            cast.framework.CastContext.getInstance().setOptions({
            receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
            autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
        }
    };
</script>

</head>
<body>
<div class="container">
    <h1 >KimmelDrive</h1>
    <google-cast-launcher style="position: fixed right;"></google-cast-launcher>
    <div id="navigation">
        <div id="current-path">Laden...</div>
        <a href="#" id="parent-link" style="display: none;">
            <span class="icon">arrow_upward</span> Bovenliggende map
        </a>
    </div>

    <h2>Inhoud</h2>
    <ul id="item-list">
        <li>Items laden...</li>
    </ul>

    <!-- Action Sections -->
    <div class="action-section">
        <h3>Nieuwe map aanmaken</h3>
        <form id="mkdir-form">
            <input type="text" id="new-folder-name" placeholder="Naam nieuwe map" style="font-family: 'Google Sans';" required>
            <button type="submit" class="m3-button">
                <span class="icon">create_new_folder</span>Map aanmaken
            </button>
        </form>
    </div>

    <div class="action-section">
        <h3>Bestand uploaden</h3>
        <form id="upload-form">
            <input type="file" id="file-input" name="file" required>
            <label for="file-input" class="file-input-label">
                 <span class="icon">upload_file</span>Selecteer Bestand...
            </label>
            <button type="submit" class="m3-button upload-btn">
                <span class="icon">upload</span>Bestand uploaden
            </button>
        </form>
        <div id="file-name-display"></div>
    </div>

    <!-- Progress bar element (add this to your HTML somewhere) -->
<div id="progressContainer" style="display:none; margin-top:10px;">
    <progress id="uploadProgress" value="0" max="100" style="width: 100%;"></progress>
    <span id="progressText">0%</span>
  </div>
  

    <!-- Status & Share -->
    <div id="status"></div>
    <div id="share-link-display">
        <p>Deel dit bestand (verloopt in 1 uur):</p>
        <input type="text" id="share-url-input" readonly title="Klik om link te kopiëren">
        <img id="share-qr-code" src="" alt="QR-code verschijnt hier">
        <div id="share-expiry-info">Scan de QR-code of kopieer de link hierboven.</div>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                 <h3 class="modal-title" id="preview-modal-title">Voorbeeld</h3>
                 <button class="icon-button close-btn" id="close-preview-modal" title="Sluiten">
                      <span class="icon">close</span>
                 </button>
            </div>
            <div class="modal-body" id="preview-content">Voorbeeld wordt geladen...</div>
        </div>
    </div>

     <!-- Editor Modal -->
    <div id="editor-modal" class="modal">
        <div class="modal-content">
             <div class="modal-header">
                 <h3 class="modal-title" id="editor-modal-title">Bestand bewerken</h3>
                 <button class="icon-button close-btn" id="close-editor-modal" title="Sluiten">
                      <span class="icon">close</span>
                 </button>
            </div>
            <div class="modal-body">
                <textarea id="editor-textarea" spellcheck="false" style="font-family: 'Google Sans';"></textarea>
            </div>
            <div class="modal-footer">
                 <button id="editor-save-button" class="m3-button">
                      <span class="icon">save</span> Opslaan
                 </button>
            </div>
        </div>
    </div>

</div>

<script>
    // --- DOM Element References ---
    const itemList = document.getElementById('item-list');
    const uploadForm = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const fileNameDisplay = document.getElementById('file-name-display');
    const mkdirForm = document.getElementById('mkdir-form');
    const newFolderNameInput = document.getElementById('new-folder-name');
    const statusDiv = document.getElementById('status');
    const currentPathDiv = document.getElementById('current-path');
    const parentLink = document.getElementById('parent-link');
    const shareDisplayDiv = document.getElementById('share-link-display');
    const shareUrlInput = document.getElementById('share-url-input');
    const shareQrCodeImg = document.getElementById('share-qr-code');
    // Preview Modal
    const previewModal = document.getElementById('preview-modal');
    const previewContent = document.getElementById('preview-content');
    const previewModalTitle = document.getElementById('preview-modal-title');
    const closePreviewModalBtn = document.getElementById('close-preview-modal');
    // Editor Modal
    const editorModal = document.getElementById('editor-modal');
    const editorTextarea = document.getElementById('editor-textarea');
    const editorModalTitle = document.getElementById('editor-modal-title');
    const closeEditorModalBtn = document.getElementById('close-editor-modal');
    const editorSaveButton = document.getElementById('editor-save-button');

    let currentDirectory = '';
    let fileToEditPath = null; // Store path while editing
    let draggedElement = null; // Store the element being dragged

    // --- Utility Functions ---
    function showStatus(message, type = 'success') {
        statusDiv.textContent = message;
        statusDiv.className = type; // Applies 'success', 'error', or 'info' class
        statusDiv.style.display = 'block';
        setTimeout(() => { if (statusDiv.textContent === message) { statusDiv.style.display = 'none'; } }, 5000);
    }

    // Debounce function to limit frequency of calls (e.g., for dragover)
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    };

    // --- Modal Handling ---
    function openModal(modalElement) { modalElement.style.display = 'flex'; document.body.style.overflow = 'hidden'; }
    function closeModal(modalElement) { modalElement.style.display = 'none'; document.body.style.overflow = ''; }

    closePreviewModalBtn.addEventListener('click', () => closeModal(previewModal));
    previewModal.addEventListener('click', (e) => { if (e.target === previewModal) closeModal(previewModal); });
    closeEditorModalBtn.addEventListener('click', () => closeModal(editorModal));
    editorModal.addEventListener('click', (e) => { if (e.target === editorModal) closeModal(editorModal); });

    document.addEventListener('keydown', (e) => { // Esc key closes modals
        if (e.key === "Escape") {
            if (previewModal.style.display === 'flex') closeModal(previewModal);
            if (editorModal.style.display === 'flex') closeModal(editorModal);
        }
    });

     // --- Preview Handler ---
     async function handlePreview(event) {
        const button = event.currentTarget;
        const itemPath = button.dataset.path;
        const itemName = button.dataset.name;
        const extension = itemName.split('.').pop()?.toLowerCase() || ''; // Safer extension getting
        const downloadUrl = `/download/${encodeURIComponent(itemPath)}`;

        previewModalTitle.textContent = `Voorbeeld: ${itemName}`;
        previewContent.innerHTML = 'Voorbeeld wordt geladen...';
        openModal(previewModal);

        try {
            if (['png', 'jpg', 'jpeg', 'gif', 'webp', 'svg', 'bmp', 'ico'].includes(extension)) { previewContent.innerHTML = `<img src="${downloadUrl}" alt="Voorbeeld">`; }
            else if (['txt', 'md', 'js', 'json', 'html', 'css', 'xml', 'log', 'py', 'sh', 'bat', 'csv', 'yaml', 'ini', 'cfg'].includes(extension)) { const response = await fetch(downloadUrl); if (!response.ok) throw new Error(`HTTP error ${response.status}`); const text = await response.text(); const escapedText = text.replace(/</g, "<").replace(/>/g, ">"); previewContent.innerHTML = `<pre>${escapedText}</pre>`; }
            else if (extension === 'pdf') { previewContent.innerHTML = `<iframe src="${downloadUrl}" title="Voorbeeld"></iframe>`; }
            else if (['mp3', 'wav', 'ogg', 'm4a', 'aac', 'flac'].includes(extension)) { previewContent.innerHTML = `<audio controls src="${downloadUrl}"></audio>`; }
            else if (['mp4', 'webm', 'ogv', 'mov', 'avi', 'mkv'].includes(extension)) {
                previewContent.innerHTML = `<video id="preview-video" controls style="width:100%; max-width:1920px; height:auto;" crossorigin="anonymous"><source src="${downloadUrl}" type="video/mp4">Je browser ondersteunt de videospeler niet.</video> `;

                // Get the shareable URL
                const shareData = await handleShare(event, false);
                if (shareData && shareData.share_url) {
                    castVideo(shareData.share_url);
                } else {
                    showStatus("Failed to generate shareable URL for casting", "error");
                }
            }
            else { previewContent.innerHTML = `<p class="preview-unavailable">Voorbeeld niet beschikbaar voor .${extension}</p>`; }
        } catch (error) { console.error('Fout bij laden voorbeeld:', error); previewContent.innerHTML = `<p class="preview-unavailable">Fout bij laden voorbeeld: ${error.message}</p>`; }
    }

    async function castVideo(videoUrl) {
        try {
            const castSession = cast.framework.CastContext.getInstance().getCurrentSession();
            if (!castSession) {
                showStatus("No cast session available", "error");
                return;
            }

            const mediaInfo = new chrome.cast.media.MediaInfo(videoUrl, 'video/mp4'); 
            const request = new chrome.cast.media.LoadRequest(mediaInfo);

            castSession.loadMedia(request).then(
                function() { console.log('Media loaded successfully'); },
                function(error) { console.error('Media load failed', error); showStatus("Failed to start casting", "error"); }
            );
        } catch (error) {
            console.error("Error initiating cast:", error);
            showStatus("Failed to initiate casting", "error");
        }
    }

    // --- Editor Handling ---
    async function handleEdit(event) {
        const button = event.currentTarget; 
        fileToEditPath = button.dataset.path;
        const itemName = button.dataset.name;
        const downloadUrl = `/download/${encodeURIComponent(fileToEditPath)}`;

        editorModalTitle.textContent = `Bewerken: ${itemName}`;
        editorTextarea.value = 'Bestandsinhoud laden...';
        editorSaveButton.disabled = true;
        openModal(editorModal);

        try {
            const response = await fetch(downloadUrl);
            if (!response.ok) throw new Error(`Kan bestand niet laden (${response.status})`);
            // Check content type to be reasonably sure it's text-like
            const contentType = response.headers.get('content-type');
            if (contentType && !contentType.startsWith('text/') && !contentType.includes('javascript') && !contentType.includes('json') && !contentType.includes('xml')) {
                 throw new Error(`Onverwacht bestandstype: ${contentType}. Kan niet bewerken.`);
            }
            const text = await response.text();
            editorTextarea.value = text;
            editorSaveButton.disabled = false;
        } catch (error) {
            console.error('Fout bij laden editor inhoud:', error);
            showStatus(`Fout bij laden bestand: ${error.message}`, 'error');
            editorTextarea.value = `*** Fout bij laden: ${error.message} ***`;
            closeModal(editorModal); // Close editor on load error
            fileToEditPath = null;
        }
    }

    editorSaveButton.addEventListener('click', async () => {
        if (!fileToEditPath) return;
        const newContent = editorTextarea.value;
        editorSaveButton.disabled = true;
        editorSaveButton.querySelector('.icon').textContent = 'hourglass_top';

        try {
            const response = await fetch('/api/save', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ filePath: fileToEditPath, content: newContent }) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Opslaan mislukt (${response.status})`);
            showStatus(data.message || 'Bestand opgeslagen!', 'success');
            closeModal(editorModal);
            fileToEditPath = null;
        } catch (error) {
            console.error('Fout bij opslaan bestand:', error);
            showStatus(`Opslaan mislukt: ${error.message}`, 'error');
            // Keep editor open maybe? depends on preference
        } finally {
             editorSaveButton.disabled = false;
             editorSaveButton.querySelector('.icon').textContent = 'save';
        }
    });

    // --- Drag and Drop Handlers ---
    function handleDragStart(event) {
        // Only allow dragging list items themselves
        const target = event.target.closest('li.item-row');
        if (!target) { event.preventDefault(); return; }

        draggedElement = target;
        event.dataTransfer.setData('text/plain', target.dataset.path);
        event.dataTransfer.effectAllowed = 'move';
        setTimeout(() => target.classList.add('dragging'), 0); // Style after browser captures drag image
        // console.log(`Drag Start: ${target.dataset.path}`);
    }

    const debouncedRemoveHover = debounce(() => {
         document.querySelectorAll('.drop-target-hover').forEach(el => el.classList.remove('drop-target-hover'));
    }, 150); // Remove hover slightly after leaving

    function handleDragOver(event) {
        event.preventDefault(); // Necessary to allow dropping
        const targetFolder = event.target.closest('li.item-row[data-is-folder="true"]');

        if (targetFolder && targetFolder !== draggedElement) {
            event.dataTransfer.dropEffect = 'move';
             // Clear previous hover immediately before adding new one
             document.querySelectorAll('.drop-target-hover').forEach(el => {
                 if (el !== targetFolder) el.classList.remove('drop-target-hover');
             });
            targetFolder.classList.add('drop-target-hover');
        } else {
            event.dataTransfer.dropEffect = 'none'; // Indicate not droppable here
            // Remove hover if dragging over a non-folder or itself
            document.querySelectorAll('.drop-target-hover').forEach(el => el.classList.remove('drop-target-hover'));
        }
    }

    function handleDragLeave(event) {
        // Use debounce to avoid flickering when moving between child elements
        debouncedRemoveHover();
    }

    function handleDrop(event) {
        event.preventDefault();
        document.querySelectorAll('.drop-target-hover').forEach(el => el.classList.remove('drop-target-hover'));
        const targetFolderElement = event.target.closest('li.item-row[data-is-folder="true"]');
        const sourcePath = event.dataTransfer.getData('text/plain');

        if (!targetFolderElement || !sourcePath || !draggedElement || targetFolderElement === draggedElement) {
            // console.log("Drop cancelled: Invalid target/source or drop on self.");
            if (draggedElement) draggedElement.classList.remove('dragging');
            draggedElement = null;
            return;
        }

        const destinationPath = targetFolderElement.dataset.path;
        const sourceName = draggedElement.dataset.name; // Use data-name attribute

        // Prevent dropping folder into itself visually (backend does more robust check)
        if (sourcePath === destinationPath) {
             if (draggedElement) draggedElement.classList.remove('dragging');
             draggedElement = null;
             return;
        }

        // console.log(`Drop: Move "${sourcePath}" into "${destinationPath}"`);
        draggedElement.classList.remove('dragging');
        moveItem(sourcePath, destinationPath, sourceName); // Call backend
        draggedElement = null;
    }

    function handleDragEnd(event) {
        // General cleanup after drag operation finishes (whether successful drop or cancelled)
        if (draggedElement) {
            draggedElement.classList.remove('dragging');
        }
        document.querySelectorAll('.drop-target-hover').forEach(el => el.classList.remove('drop-target-hover'));
        draggedElement = null;
        // console.log("Drag End");
    }

    // Add drag listeners using event delegation on the list container
    itemList.addEventListener('dragstart', handleDragStart);
    itemList.addEventListener('dragover', handleDragOver);
    itemList.addEventListener('dragleave', handleDragLeave); // Use dragleave for hover removal
    itemList.addEventListener('drop', handleDrop);
    itemList.addEventListener('dragend', handleDragEnd); // Cleanup on drag end


    // --- Backend Interaction for Moving ---
    async function moveItem(sourcePath, destinationPath, sourceName) {
        showStatus(`Bezig met verplaatsen "${sourceName}"...`, 'info');
        try {
            const response = await fetch('/api/move', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sourcePath: sourcePath, destinationPath: destinationPath }) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Verplaatsen mislukt (${response.status})`);
            showStatus(data.message || `"${sourceName}" succesvol verplaatst.`, 'success');
            loadDirectory(currentDirectory); // Refresh view
        } catch (error) {
            console.error('Fout bij verplaatsen item:', error);
            showStatus(`Verplaatsen mislukt: ${error.message}`, 'error');
            loadDirectory(currentDirectory); // Refresh even on error
        }
    }


    // --- loadDirectory (Main rendering function) ---
    async function loadDirectory(relativePath = '') {
        statusDiv.style.display = 'none';
        shareDisplayDiv.style.display = 'none';
        itemList.innerHTML = `<li style="padding: 16px; color: var(--md-sys-color-on-surface-variant);">Items laden...</li>`; // Use style for consistency
        currentPathDiv.textContent = `Huidig pad: /${relativePath || ''}`;
        currentDirectory = relativePath;
        const browseUrl = `/api/browse/${encodeURIComponent(relativePath)}`;

        try {
            const response = await fetch(browseUrl);
            if (!response.ok) {
                 const errorData = await response.json().catch(() => ({ error: `HTTP-fout ${response.status}` })); // Attempt to get JSON error
                 throw new Error(errorData.error || `HTTP-fout ${response.status}`);
            }
            const data = await response.json();
            itemList.innerHTML = ''; // Clear loading/previous list

            // Parent link
            if (data.parent_path !== null && data.parent_path !== undefined) {
                parentLink.style.display = 'inline-flex';
                parentLink.dataset.path = data.parent_path;
            } else {
                parentLink.style.display = 'none';
            }

            if (data.items && data.items.length > 0) {
                data.items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'item-row';
                    li.dataset.path = item.path;
                    li.dataset.name = item.name;
                    li.setAttribute('draggable', 'true');
                    if (item.is_dir) li.dataset.isFolder = "true";

                    // Item Info (Icon + Name/Link)
                    const itemInfoDiv = document.createElement('div');
                    itemInfoDiv.className = 'item-info';
                    const iconSpan = document.createElement('span');
                    iconSpan.className = 'icon';
                    iconSpan.textContent = item.is_dir ? 'folder' : 'draft'; // Use symbol names
                    itemInfoDiv.appendChild(iconSpan);

                    let nameElement;
                    if (item.is_dir) {
                        nameElement = document.createElement('a');
                        nameElement.textContent = item.name;
                        nameElement.href = '#';
                        nameElement.className = 'folder-link';
                        nameElement.addEventListener('click', (e) => { e.preventDefault(); loadDirectory(item.path); });
                    } else {
                        nameElement = document.createElement('span');
                        nameElement.textContent = item.name;
                    }
                    itemInfoDiv.appendChild(nameElement);
                    li.appendChild(itemInfoDiv);

                    // Item Actions
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'item-actions';

                    if (!item.is_dir) {
                        // Download
                        const downloadLink = document.createElement('a');
                        downloadLink.href = `/download/${encodeURIComponent(item.path)}`;
                        downloadLink.title = "Downloaden";
                        downloadLink.className = 'icon-button download-link';
                        downloadLink.setAttribute('download', item.name);
                        downloadLink.innerHTML = `<span class="icon">download</span>`;
                        actionsDiv.appendChild(downloadLink);

                        // Preview
                        const previewBtn = document.createElement('button');
                        previewBtn.title = "Voorbeeld";
                        previewBtn.className = 'icon-button preview-btn';
                        previewBtn.dataset.path = item.path; previewBtn.dataset.name = item.name;
                        previewBtn.innerHTML = `<span class="icon">visibility</span>`;
                        previewBtn.addEventListener('click', handlePreview);
                        actionsDiv.appendChild(previewBtn);

                        // Edit Button (Conditional)
                        const editableExtensions = ['txt', 'md', 'js', 'json', 'html', 'css', 'xml', 'log', 'py', 'sh', 'bat', 'csv', 'yaml', 'ini', 'cfg'];
                        const extension = item.name.split('.').pop()?.toLowerCase() || '';
                        if (editableExtensions.includes(extension)) {
                            const editBtn = document.createElement('button');
                            editBtn.title = "Bewerken";
                            editBtn.className = 'icon-button edit-btn';
                            editBtn.dataset.path = item.path; editBtn.dataset.name = item.name;
                            editBtn.innerHTML = `<span class="icon">edit</span>`;
                            editBtn.addEventListener('click', handleEdit);
                            actionsDiv.appendChild(editBtn);
                        }

                        // Share
                        const shareBtn = document.createElement('button');
                        shareBtn.title = "Delen";
                        shareBtn.className = 'icon-button share-btn';
                        shareBtn.dataset.path = item.path;
                        shareBtn.innerHTML = `<span class="icon">share</span>`;
                        shareBtn.addEventListener('click', handleShare);
                        actionsDiv.appendChild(shareBtn);
                    }

                    // Delete (common action)
                    const deleteBtn = document.createElement('button');
                    deleteBtn.title = "Verwijderen";
                    deleteBtn.className = 'icon-button delete-btn';
                    deleteBtn.dataset.path = item.path; deleteBtn.dataset.name = item.name;
                    deleteBtn.innerHTML = `<span class="icon">delete</span>`;
                    deleteBtn.addEventListener('click', handleDelete);
                    actionsDiv.appendChild(deleteBtn);

                    li.appendChild(actionsDiv);
                    itemList.appendChild(li);
                });
            } else {
                itemList.innerHTML = `<li style="padding: 16px; color: var(--md-sys-color-on-surface-variant); cursor: default;"><em>Deze map is leeg.</em></li>`;
            }
        } catch (error) {
            console.error('Fout bij laden van map:', error);
            itemList.innerHTML = `<li style="padding: 16px; color: var(--md-sys-color-error); cursor: default;">Fout bij laden van inhoud: ${error.message}</li>`;
            showStatus(`Fout bij laden van inhoud: ${error.message}`, 'error');
        }
    }


    // --- Other Event Listeners ---
    // Share button handler (no changes needed from previous)
    async function handleShare(event, showUI = true) {
    const button = event.currentTarget;
    const itemPath = button.dataset.path;
    shareDisplayDiv.style.display = 'none';
    showStatus('Deellink en QR-code worden gegenereerd...', 'info');
    try {
        const response = await fetch('/api/share', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ path: itemPath })
        });
        const data = await response.json();
        if (!response.ok) throw new Error(data.error || `Fout bij aanmaken link (${response.status})`);
        shareUrlInput.value = data.share_url;
        if (data.qr_code_data_url) {
            shareQrCodeImg.src = data.qr_code_data_url;
            shareQrCodeImg.style.display = 'block';
        } else {
            shareQrCodeImg.style.display = 'none';
            showStatus('Deellink gegenereerd, maar QR-code mislukt.', 'error');
        }
        if (showUI) {
            shareDisplayDiv.style.display = 'block';
            shareDisplayDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            if (data.qr_code_data_url) showStatus('Deellink & QR gegenereerd (geldig 1 uur). Klik linkbox om te kopiëren.', 'success');
        }
        return data; // Return the data containing the share URL
    } catch (error) {
        console.error('Fout bij aanmaken deellink:', error);
        showStatus(`Fout bij aanmaken deellink: ${error.message}`, 'error');
        shareDisplayDiv.style.display = 'none';
        return null;
    }
}

    // Copy link handler (no changes needed from previous)
     shareUrlInput.addEventListener('click', () => { /* ... Same as before ... */
        shareUrlInput.select();
        try {
            if (navigator.clipboard && navigator.clipboard.writeText) { navigator.clipboard.writeText(shareUrlInput.value).then(() => { showStatus('Link gekopieerd!', 'success'); }).catch(err => { throw err; }); }
            else if (!document.execCommand('copy')) { throw new Error('document.execCommand failed'); }
            else { showStatus('Link gekopieerd! (fallback)', 'success'); }
        } catch (err) { console.error('Fout bij kopiëren naar klembord:', err); showStatus('Automatisch kopiëren mislukt. Kopieer handmatig.', 'error'); }
     });

    // Delete handler (no changes needed from previous)
     async function handleDelete(event) { /* ... Same as before ... */
        const button = event.currentTarget;
        const itemPath = button.dataset.path;
        const itemName = button.dataset.name;
        if (!confirm(`Weet je zeker dat je "${itemName}" permanent wilt verwijderen?`)) { return; }
        statusDiv.style.display = 'none';
        try {
            const response = await fetch('/api/delete', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ path: itemPath }) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Verwijderen mislukt (${response.status})`);
            showStatus(data.message || 'Item succesvol verwijderd.', 'success');
            loadDirectory(currentDirectory);
        } catch (error) { console.error('Fout bij verwijderen item:', error); showStatus(`Verwijderen mislukt: ${error.message}`, 'error'); }
     }

    // Parent link click
    parentLink.addEventListener('click', (e) => { e.preventDefault(); loadDirectory(parentLink.dataset.path); });

    // Mkdir form submit
    mkdirForm.addEventListener('submit', async (event) => { /* ... Same as before ... */
        event.preventDefault(); statusDiv.style.display = 'none';
        const newFolderName = newFolderNameInput.value.trim();
        if (!newFolderName) { showStatus('Voer een mapnaam in.', 'error'); return; }
        showStatus(`Map "${newFolderName}" wordt aangemaakt...`, 'info');
        try {
            const response = await fetch('/api/mkdir', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ parent_path: currentDirectory, dir_name: newFolderName }) });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || `Map aanmaken mislukt (${response.status})`);
            showStatus(data.message || 'Map aangemaakt.', 'success');
            newFolderNameInput.value = ''; loadDirectory(currentDirectory);
        } catch (error) { showStatus(`Map aanmaken mislukt: ${error.message}`, 'error'); }
    });

    // File input change handler
    fileInput.addEventListener('change', () => { /* ... Same as before ... */
        if (fileInput.files.length > 0) { fileNameDisplay.textContent = `Geselecteerd: ${fileInput.files[0].name}`; }
        else { fileNameDisplay.textContent = ''; }
    });

    // Upload form submit
    uploadForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    statusDiv.style.display = 'none';

    if (!fileInput.files || fileInput.files.length === 0) {
        showStatus('Selecteer een bestand.', 'error');
        return;
    }

    const file = fileInput.files[0];
    const formData = new FormData();
    formData.append('file', file);

    showStatus(`"${file.name}" wordt geüpload...`, 'info');

    const uploadUrl = `/api/upload/${encodeURIComponent(currentDirectory)}`;

    // Get references to progress bar elements
    const progressContainer = document.getElementById('progressContainer');
    const uploadProgress = document.getElementById('uploadProgress');
    const progressText = document.getElementById('progressText');

    progressContainer.style.display = 'block';
    uploadProgress.value = 0;
    progressText.textContent = '0%';

    try {
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                uploadProgress.value = percent;
                progressText.textContent = `${percent}%`;
            }
        });

        xhr.upload.addEventListener('load', () => {
            uploadProgress.value = 100;
            progressText.textContent = '100%';
        });

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                progressContainer.style.display = 'none';
                const response = JSON.parse(xhr.responseText);
                if (xhr.status >= 200 && xhr.status < 300) {
                    showStatus(response.message || 'Bestand geüpload!', 'success');
                    fileInput.value = '';
                    fileNameDisplay.textContent = '';
                    loadDirectory(currentDirectory);
                } else {
                    showStatus(response.error || `Uploaden mislukt (${xhr.status})`, 'error');
                }
            }
        };

        xhr.open('POST', uploadUrl);
        xhr.send(formData);
    } catch (error) {
        progressContainer.style.display = 'none';
        showStatus(`Uploaden mislukt: ${error.message}`, 'error');
    }
});


    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => loadDirectory(''));
</script>

</body>
</html>